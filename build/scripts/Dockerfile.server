FROM node:14 AS build-stage

# Create svaefh directory
WORKDIR /usr/src/svaefh

# Install Nexe
RUN npm i nexe@3.3.7 -g

# Install svaefh Server Dependencies
COPY package*.json ./
RUN npm install --only=production

# Bundle svaefh Source
COPY . .

# Build
RUN nexe app.js -r config/*.js -r config/config.env -r middleware/*.js -r models/*.js -r routes/*.js -t linux-x64-12.14.1 -o server

# Copy to Build
FROM scratch AS export-stage
COPY --from=build-stage /usr/src/svaefh/server /server
